<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>How to persist your configuration in GKE</title>

  <meta name="author" content="Antón R. Yuste" />
  
  

  <meta name="generator" content="Hugo 0.16" />

  <link rel="alternate" href="https://antonmry.github.io/index.xml" type="application/rss+xml" title="errors.New(&#34;antonmry: blog&#34;)">

  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://antonmry.github.io/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://antonmry.github.io/css/main.css" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://antonmry.github.io/css/pygment_highlights.css" />
  
  
  <meta property="og:title" content="How to persist your configuration in GKE" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/" />
  <meta property="og:image" content="img/avatar-icon.png" />

  <link rel="shortcut icon" href="favicon.ico">
  
</head>


  <body>

    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://antonmry.github.io/">errors.New(&#34;antonmry: blog&#34;)</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
          <li>
          <a title="Blog" href="/">Blog</a>
  	      </li>
  	    
      
        
          <li>
          <a title="About" href="/page/about/">About</a>
  	      </li>
  	    
      
      </ul>
    </div>

	<div class="avatar-container">
	  <div class="avatar-img-border">
      
          <a title="errors.New(&#34;antonmry: blog&#34;)" href="https://antonmry.github.io/">
              <img class="avatar-img" src="https://antonmry.github.io/img/avatar-icon.png" alt="errors.New(&#34;antonmry: blog&#34;)" />
          </a>
      
	  </div>
	</div>

  </div>
</nav>


    <div role="main" class="container main-content">

      
        





<header class="header-section ">

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>How to persist your configuration in GKE</h1>
      
      
      
      <span class="post-meta">Posted on January 9, 2017</span>
      
        </div>
      </div>
    </div>
  </div>
</div>

<link rel="shortcut icon" href="favicon.ico">
</header>





<div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
          

<p>In my previous post, <a href="https://antonmry.github.io/post/deploy-on-kubernetes-gke-with-terraform/">Deploy on Kubernetes GKE with Terraform</a>, we&rsquo;ve seen how to start to use kubernetes but in a very simple way. The next thing we would like to do is persist the configuration, so we don&rsquo;t need to reconfigure our bot each time we start the cluster. This post explain how to do it from the configuration created in the previous one.</p>

<p>Again we&rsquo;ll use <a href="https://github.com/antonmry/leanmanager">Leanmanager bot</a> but everything applies to any other system which needs to store configuration or data in a database. In the case of <a href="https://github.com/antonmry/leanmanager">Leanmanager</a> we are using <a href="https://github.com/boltdb/bolt">Boltdb</a>, a pure Go key/value store. <a href="https://github.com/boltdb/bolt">Boltdb</a> is great for development but it doesn&rsquo;t support to have more than one process opening the same database file, so it may be problematic if we want to have more than one Docker instance at the same time. Yet it&rsquo;s enough for our purposes and the process is similar for <a href="https://www.consul.io/">Consul</a> which it&rsquo;s already in the Roadmap.</p>

<h2 id="create-your-persistent-disks">Create your persistent disks</h2>

<p>If we want to persist data, we are going to need a disk, that&rsquo;s common sense. In GCE we can do it very easily:</p>

<pre><code class="language-sh">gcloud compute disks create --size 1GB leanmanager-disk
</code></pre>

<p>But again, we want to do it in an automated way with Terraform. Use the following file <code>leanmanager-disk.tf</code>:</p>

<pre><code>variable &quot;disk_name&quot; {
  default = &quot;leanmanager-disk&quot;
}

resource &quot;google_compute_disk&quot; &quot;default&quot; {
name  = &quot;${var.disk_name}&quot;
  type  = &quot;pd-ssd&quot;
  zone = &quot;${var.region}&quot;
  size  = &quot;1&quot;
}
</code></pre>

<p>If you want to know more about it, visit the <a href="https://www.terraform.io/docs/providers/google/r/compute_disk.html">Terraform Google_Compute_Disk reference documentation</a>.</p>

<h2 id="tell-the-container-about-the-disk">Tell the container about the disk</h2>

<p>In our previous post, we&rsquo;ve launched the bot using <code>kubectl run</code>. This is OK for simple configuration but if we need to have something more complex, it doesn&rsquo;t scale. We can create a <a href="http://kubernetes.io/docs/user-guide/pods/">pod</a>, a group of one or more containers, using a YAML file like this:</p>

<pre><code>apiVersion: v1
kind: Pod
metadata:
  name: leanmanager
  labels:
    name: leanmanager
spec:
  containers:
    - image: antonmry/leanmanager:latest
      name: leanmanager
      env:
        - name: LEANMANAGER_TOKEN
          value: LEANMANAGER_TOKEN_TEMPLATE
        - name: LEANMANAGER_PATHDB
          value: /mnt
      volumeMounts:
          # This name must match the volumes.name below.
        - name: leanmanager-persistent-storage
          mountPath: /mnt
  volumes:
    - name: leanmanager-persistent-storage
      gcePersistentDisk:
        # This disk must already exist.
        pdName: leanmanager-disk
        fsType: ext4
</code></pre>

<p>The file is auto-explanatory except the value <code>LEANMANAGER_TOKEN_TEMPLATE</code>. I don&rsquo;t want to hardcode the Token here because the file will be uploaded to Github. Instead of that, I want to use my local environment variable LEANMANAGER_TOKEN but this isn&rsquo;t supported yet in K8s, see <a href="http://stackoverflow.com/questions/33478555/kubernetes-equivalent-of-env-file-in-docker">Kubernetes equivalent of env-file in Docker</a>.</p>

<p>So I&rsquo;ve created a YAML template and in the Terraform file changed the last <code>local-exec</code> to:</p>

<pre><code>  provisioner &quot;local-exec&quot; {
    command = &quot;cp leanmanager-pod-template.yaml leanmanager.tmp.yaml &amp;&amp; sed -i -- 's/LEANMANAGER_TOKEN_TEMPLATE/${var.LEANMANAGER_TOKEN}/g' leanmanager.tmp.yaml&quot;
  }

  provisioner &quot;local-exec&quot; {
    command = &quot;kubectl create -f leanmanager.tmp.yaml&quot;
  }

  provisioner &quot;local-exec&quot; {
    command = &quot;rm -f leanmanager.tmp.yaml&quot;
  }
</code></pre>

<p>Basically, I&rsquo;m replacing strings with <code>sed</code>. Other more sophisticate approaches are possible as K8s secrets or Ansible, but this is simple and enough for the task we want to do.</p>

<h2 id="create-the-pod-and-test">Create the pod and test</h2>

<p>Time to create the cluster and the pod:</p>

<pre><code class="language-sh">terraform plan
terraform apply -var LEANMANAGER_TOKEN=$LEANMANAGER_TOKEN
</code></pre>

<p>The bot should connect. Now we can do some changes in the configuration, delete the pod:</p>

<pre><code class="language-sh">kubectl delete pod leanmanager
</code></pre>

<p>Create it again:</p>

<pre><code class="language-sh">kubectl create -f leanmanager.yaml
</code></pre>

<p>And check the status with the following commands and, once it&rsquo;s in <em>Running</em> state, see if everything has been persisted:</p>

<pre><code class="language-sh">kubectl get pod leanmanager
kubectl logs leanmanager
</code></pre>

<h2 id="conclusion">Conclusion</h2>

<p>Persist data in Kubernetes is quite easy, even if you are going to do it automatically.</p>

<p>If you want to check all the files, the full project and the associated PR are in <a href="https://github.com/antonmry/leanmanager/pull/27/commits/ffea981b5deca5376b7bb8de1ed797da9aa282b0">Github</a>.</p>

<h2 id="not-already-linked-but-useful-resources">Not already linked but useful resources</h2>

<ul>
<li><a href="http://kubernetes.io/docs/user-guide/persistent-volumes/">Kubernetes persistent volumes</a></li>
<li><a href="https://cloud.google.com/container-engine/docs/tutorials/persistent-disk/">Using Persistent Disks with WordPress and MySQL</a></li>
</ul>

      </article>

      <ul class="pager blog-pager">
        
        <li class="previous">
          <a href="https://antonmry.github.io/post/deploy-on-kubernetes-gke-with-terraform/" data-toggle="tooltip" data-placement="top" title="Deploy on kubernetes GKE with Terraform">&larr; Previous Post</a>
        </li>
        
        
      </ul>

      

    </div>
  </div>
</div>

      

    </div>

    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          <li>
            <a href="https://github.com/antonmry" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
          <li>
            <a href="https://twitter.com/antonmry" title="Twitter">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
          <li>
            <a href="mailto:antonmry@galiglobal.com" title="Email me">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
	    	  
          <li>
            <a href="https://stackoverflow.com/users/6002794/ant%c3%b3n-r-yuste" title="StackOverflow">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-stack-overflow fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          

    		  <li>
      			<a href="https://antonmry.github.io/index.xml" title="RSS">
      			  <span class="fa-stack fa-lg">
        				<i class="fa fa-circle fa-stack-2x"></i>
        				<i class="fa fa-rss fa-stack-1x fa-inverse"></i>
      			  </span>
      			</a>
    		  </li>		

        </ul>
        <p class="copyright text-muted">
    		  Antón R. Yuste
    		  &nbsp;&bull;&nbsp;
    		  2017
    		  
    		  
    		  &nbsp;&bull;&nbsp;
    		  <a href="https://antonmry.github.io/">errors.New(&#34;antonmry: blog&#34;)</a>
    		  
  	    </p>
    		<p class="theme-by text-muted">
    		  Powered by
    		  <a href="https://gohugo.io/">hugo</a>.&nbsp;
  	        
    		  Theme by
    		  <a href="http://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
    		</p>
      </div>
    </div>
  </div>
</footer>

<script src="https://antonmry.github.io/js/jquery-1.11.2.min.js"></script>
<script src="https://antonmry.github.io/js/bootstrap.min.js"></script>
<script src="https://antonmry.github.io/js/main.js"></script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-79438780-1', 'auto');
ga('send', 'pageview');
</script>



  </body>
</html>
